<template>
  <div id="app" class="min-h-screen bg-light">
    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-50">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-primary">ğŸ‡¯ğŸ‡µ äº¬éƒ½å¤§é˜ªä¸ƒå¤©å…­å¤œä¹‹æ—…</h1>
            <p class="text-sm text-gray-600">2026å¹´1æœˆ16æ—¥ - 1æœˆ22æ—¥</p>
          </div>
          <div class="text-right">
            <div id="header-weather" class="text-sm text-gray-600">
              <div class="weather-loading">è¼‰å…¥å¤©æ°£ä¸­...</div>
            </div>
            <div id="countdown" class="text-xs text-gray-500 mt-1">
              <div class="countdown-label">è·é›¢å‡ºç™¼é‚„æœ‰</div>
              <div class="countdown-timer flex space-x-1">
                <div class="countdown-item">
                  <span id="countdown-days" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">å¤©</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-hours" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">æ™‚</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-minutes" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">åˆ†</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-seconds" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">ç§’</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Horizontal Date Navigation -->
    <nav class="bg-white border-b sticky top-20 z-40 overflow-x-auto">
      <div class="flex space-x-1 px-4 py-2 min-w-max">
        <button
          v-for="day in days"
          :key="day.id"
          @click="activeDay = day.id"
          :class="[
            'nav-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap',
            activeDay === day.id
              ? 'bg-primary text-white shadow-md'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          ]"
        >
          {{ day.label }}
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
      <!-- Overview Section -->
      <div v-if="activeDay === 'overview'" class="space-y-6">
        <h2 class="text-2xl font-bold text-dark mb-6">è¡Œç¨‹ç¸½è¦½</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ“… æ—…éŠæ—¥æœŸ</h3>
            <p class="text-gray-700">2026å¹´1æœˆ16æ—¥ - 1æœˆ22æ—¥</p>
            <p class="text-sm text-gray-500 mt-1">å…±7å¤©6å¤œ</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ“ ç›®çš„åœ°</h3>
            <p class="text-gray-700">äº¬éƒ½ã€å¤§é˜ªã€å¤©æ©‹ç«‹</p>
            <p class="text-sm text-gray-500 mt-1">é—œè¥¿åœ°å€æ·±åº¦éŠ</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸš„ äº¤é€šæ–¹å¼</h3>
            <p class="text-gray-700">JR HARUKAã€ICOCAã€KKdayä¸€æ—¥éŠ</p>
            <p class="text-sm text-gray-500 mt-1">å«ä¸¹å¾Œç´…æ¾è™Ÿéµé“</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ¨ ä½å®¿</h3>
            <p class="text-gray-700">äº¬éƒ½2æ™šã€å¤§é˜ª2æ™šã€ç’°çƒ2æ™š</p>
            <p class="text-sm text-gray-500 mt-1">æº«æ³‰é£¯åº—é«”é©—</p>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold text-dark mb-4">è¡Œç¨‹äº®é»</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸ›ï¸</span>
                <div>
                  <h4 class="font-semibold text-dark">ä¸–ç•Œéºç”¢å·¡ç¦®</h4>
                  <p class="text-sm text-gray-600">æ¸…æ°´å¯ºã€é‡‘é–£å¯ºã€ä¼è¦‹ç¨»è·å¤§ç¤¾ç­‰</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸŒ</span>
                <div>
                  <h4 class="font-semibold text-dark">å‚³çµ±æ–‡åŒ–é«”é©—</h4>
                  <p class="text-sm text-gray-600">ç¥‡åœ’è—ä¼ã€äº¬éƒ½è—ä¼é«”é©—</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸœ</span>
                <div>
                  <h4 class="font-semibold text-dark">ç¾é£Ÿæ¢ç´¢</h4>
                  <p class="text-sm text-gray-600">äº¬éƒ½æ‡·çŸ³æ–™ç†ã€å¤§é˜ªç« é­šç‡’ã€é°»é­šé£¯</p>
                </div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸš„</span>
                <div>
                  <h4 class="font-semibold text-dark">äº¤é€šä¾¿åˆ©</h4>
                  <p class="text-sm text-gray-600">JR HARUKAç›´é”ã€ICOCAä¸€å¡é€š</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸŒ¸</span>
                <div>
                  <h4 class="font-semibold text-dark">å››å­£ä¹‹ç¾</h4>
                  <p class="text-sm text-gray-600">å†¬å­£è³é›ªã€æº«æ³‰é«”é©—</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸ¢</span>
                <div>
                  <h4 class="font-semibold text-dark">ä¸»é¡Œæ¨‚åœ’</h4>
                  <p class="text-sm text-gray-600">ç’°çƒå½±åŸã€äº¬éƒ½æ°´æ—é¤¨</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Day Sections with Map -->
      <div v-else class="space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-dark">{{ getCurrentDayTitle() }}</h2>
          <button
            @click="showMap = !showMap"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 flex items-center space-x-2"
          >
            <span>ğŸ—ºï¸</span>
            <span>{{ showMap ? 'éš±è—åœ°åœ–' : 'é¡¯ç¤ºåœ°åœ–' }}</span>
          </button>
        </div>

        <!-- Map Section -->
        <div v-if="showMap" class="bg-white rounded-lg shadow-md overflow-hidden">
          <div id="map" class="h-96 w-full"></div>
        </div>

        <!-- Itinerary Section -->
        <div class="space-y-4">
          <div
            v-for="(item, index) in getCurrentDayItinerary()"
            :key="index"
            class="bg-white rounded-lg shadow-md p-4"
          >
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                  {{ item.time }}
                </div>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-dark mb-2">{{ item.title }}</h3>
                <p class="text-gray-600 mb-2">{{ item.description }}</p>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                  <span v-if="item.transport">ğŸš„ {{ item.transport }}</span>
                  <span v-if="item.location">ğŸ“ {{ item.location }}</span>
                  <span v-if="item.duration">â±ï¸ {{ item.duration }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script>
import { ref, onMounted, onUnmounted } from 'vue'
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'

export default {
  name: 'App',
  setup() {
    const activeDay = ref('overview')
    const showMap = ref(false)
    const map = ref(null)
    const markers = ref([])
    const userMarker = ref(null)

    const days = [
      { id: 'overview', label: 'ç¸½è¦½' },
      { id: 'day1', label: 'Day 1' },
      { id: 'day2', label: 'Day 2' },
      { id: 'day3', label: 'Day 3' },
      { id: 'day4', label: 'Day 4' },
      { id: 'day5', label: 'Day 5' },
      { id: 'day6', label: 'Day 6' },
      { id: 'day7', label: 'Day 7' }
    ]

    // è¡Œç¨‹è³‡æ–™
    const itineraryData = {
      day1: [
        {
          time: '08:00',
          title: 'æ¡ƒåœ’æ©Ÿå ´é›†åˆ',
          description: 'é›†åˆæ™‚é–“è«‹æº–æ™‚åˆ°é”ï¼Œé€¾æ™‚ä¸å€™',
          transport: 'æ¡ƒåœ’æ©Ÿå ´ â†’ é—œè¥¿æ©Ÿå ´',
          location: 'æ¡ƒåœ’æ©Ÿå ´',
          duration: 'é£›è¡Œç´„3å°æ™‚',
          coordinates: [25.0779, 121.2320]
        },
        {
          time: '11:30',
          title: 'æŠµé”æˆç”°æ©Ÿå ´',
          description: 'è¾¦ç†å…¥å¢ƒæ‰‹çºŒï¼Œé ˜å–è¡Œæ',
          location: 'æˆç”°æ©Ÿå ´',
          duration: 'ç´„1å°æ™‚',
          coordinates: [35.7720, 140.3929]
        },
        {
          time: '13:00',
          title: 'è½‰ä¹˜JR HARUKA',
          description: 'å¾æˆç”°æ©Ÿå ´æ­ä¹˜JR HARUKAå‰å¾€äº¬éƒ½',
          transport: 'JR HARUKA',
          location: 'äº¬éƒ½ç«™',
          duration: 'ç´„2.5å°æ™‚',
          coordinates: [34.9854, 135.7581]
        },
        {
          time: '15:30',
          title: 'å…¥ä½äº¬éƒ½é£¯åº—',
          description: 'ä¼‘æ¯èª¿æ•´æ™‚å·®ï¼Œç†Ÿæ‚‰å‘¨é‚Šç’°å¢ƒ',
          location: 'äº¬éƒ½é£¯åº—',
          duration: 'ä¼‘æ¯2å°æ™‚',
          coordinates: [35.0116, 135.7681]
        },
        {
          time: '17:30',
          title: 'ç¥‡åœ’æ•£ç­–',
          description: 'æ¼«æ­¥ç¥‡åœ’èŠ±è¦‹å°è·¯ï¼Œæ„Ÿå—äº¬éƒ½å¤éƒ½é¢¨æƒ…',
          location: 'ç¥‡åœ’',
          duration: 'ç´„2å°æ™‚',
          coordinates: [35.0044, 135.7740]
        },
        {
          time: '19:30',
          title: 'æ™šé¤',
          description: 'å“åšäº¬éƒ½ç‰¹è‰²æ–™ç†',
          location: 'ç¥‡åœ’é¤å»³',
          duration: 'ç´„1å°æ™‚',
          coordinates: [35.0044, 135.7740]
        }
      ],
      day2: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'äº¬éƒ½é£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [35.0116, 135.7681]
        },
        {
          time: '09:00',
          title: 'æ¸…æ°´å¯º',
          description: 'åƒè§€ä¸–ç•Œéºç”¢æ¸…æ°´å¯ºï¼Œä¿¯ç°äº¬éƒ½å…¨æ™¯',
          transport: 'å…¬è»Š',
          location: 'æ¸…æ°´å¯º',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.9949, 135.7850]
        },
        {
          time: '11:30',
          title: 'é‡‘é–£å¯º',
          description: 'åƒè§€é‡‘é–£å¯ºï¼Œæ¬£è³é‡‘è‰²å»ºç¯‰ä¹‹ç¾',
          transport: 'å…¬è»Š',
          location: 'é‡‘é–£å¯º',
          duration: 'ç´„1.5å°æ™‚',
          coordinates: [35.0394, 135.7292]
        },
        {
          time: '13:30',
          title: 'åˆé¤',
          description: 'äº¬éƒ½æ‡·çŸ³æ–™ç†',
          location: 'é‡‘é–£å¯ºé™„è¿‘',
          duration: '1å°æ™‚',
          coordinates: [35.0394, 135.7292]
        },
        {
          time: '15:00',
          title: 'ä¼è¦‹ç¨»è·å¤§ç¤¾',
          description: 'åƒè§€åƒæœ¬é³¥å±…ï¼Œæ‹æ”ç¶“å…¸ç…§ç‰‡',
          transport: 'åœ°éµ',
          location: 'ä¼è¦‹ç¨»è·å¤§ç¤¾',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.9671, 135.7727]
        },
        {
          time: '18:00',
          title: 'è¿”å›é£¯åº—',
          description: 'ä¼‘æ¯æº–å‚™æ™šé¤',
          transport: 'åœ°éµ',
          location: 'äº¬éƒ½é£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [35.0116, 135.7681]
        },
        {
          time: '19:00',
          title: 'æ™šé¤',
          description: 'äº¬éƒ½ç‰¹è‰²æ–™ç†',
          location: 'é£¯åº—é™„è¿‘',
          duration: '1å°æ™‚',
          coordinates: [35.0116, 135.7681]
        }
      ],
      day3: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'äº¬éƒ½é£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [35.0116, 135.7681]
        },
        {
          time: '09:00',
          title: 'äº¬éƒ½å¾¡æ‰€',
          description: 'åƒè§€äº¬éƒ½å¾¡æ‰€ï¼Œäº†è§£æ—¥æœ¬çš‡å®¤æ­·å²',
          transport: 'å…¬è»Š',
          location: 'äº¬éƒ½å¾¡æ‰€',
          duration: 'ç´„1.5å°æ™‚',
          coordinates: [35.0254, 135.7621]
        },
        {
          time: '11:00',
          title: 'äºŒæ¢åŸ',
          description: 'åƒè§€äºŒæ¢åŸï¼Œä¸–ç•Œéºç”¢å»ºç¯‰',
          transport: 'å…¬è»Š',
          location: 'äºŒæ¢åŸ',
          duration: 'ç´„2å°æ™‚',
          coordinates: [35.0142, 135.7483]
        },
        {
          time: '13:30',
          title: 'åˆé¤',
          description: 'äº¬éƒ½æ–™ç†',
          location: 'äºŒæ¢åŸé™„è¿‘',
          duration: '1å°æ™‚',
          coordinates: [35.0142, 135.7483]
        },
        {
          time: '15:00',
          title: 'äº¬éƒ½è—ä¼é«”é©—',
          description: 'é«”é©—äº¬éƒ½è—ä¼æ–‡åŒ–ï¼Œå­¸ç¿’å‚³çµ±èˆè¹ˆ',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'ç¥‡åœ’',
          duration: 'ç´„3å°æ™‚',
          coordinates: [35.0044, 135.7740]
        },
        {
          time: '19:00',
          title: 'æ™šé¤',
          description: 'è—ä¼å€ç‰¹è‰²æ–™ç†',
          location: 'ç¥‡åœ’',
          duration: '1å°æ™‚',
          coordinates: [35.0044, 135.7740]
        }
      ],
      day4: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'äº¬éƒ½é£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [35.0116, 135.7681]
        },
        {
          time: '09:00',
          title: 'è½‰å¾€å¤§é˜ª',
          description: 'æ­ä¹˜JRå‰å¾€å¤§é˜ª',
          transport: 'JR',
          location: 'å¤§é˜ªç«™',
          duration: 'ç´„30åˆ†é˜',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '10:00',
          title: 'å…¥ä½å¤§é˜ªé£¯åº—',
          description: 'ä¼‘æ¯èª¿æ•´',
          location: 'å¤§é˜ªé£¯åº—',
          duration: '1å°æ™‚',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '11:00',
          title: 'å¤§é˜ªåŸ',
          description: 'åƒè§€å¤§é˜ªåŸï¼Œäº†è§£æ—¥æœ¬æ­·å²',
          transport: 'åœ°éµ',
          location: 'å¤§é˜ªåŸ',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.6873, 135.5262]
        },
        {
          time: '14:00',
          title: 'åˆé¤',
          description: 'å¤§é˜ªç« é­šç‡’',
          location: 'å¤§é˜ªåŸé™„è¿‘',
          duration: '1å°æ™‚',
          coordinates: [34.6873, 135.5262]
        },
        {
          time: '15:30',
          title: 'å¿ƒé½‹æ©‹è³¼ç‰©',
          description: 'å¤§é˜ªçŸ¥åè³¼ç‰©å€ï¼Œè¡€æ‹¼æ™‚é–“',
          transport: 'åœ°éµ',
          location: 'å¿ƒé½‹æ©‹',
          duration: 'ç´„3å°æ™‚',
          coordinates: [34.6739, 135.5011]
        },
        {
          time: '19:00',
          title: 'æ™šé¤',
          description: 'å¤§é˜ªç¾é£Ÿ',
          location: 'å¿ƒé½‹æ©‹',
          duration: '1å°æ™‚',
          coordinates: [34.6739, 135.5011]
        }
      ],
      day5: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'å¤§é˜ªé£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '09:00',
          title: 'ç’°çƒå½±åŸ',
          description: 'åˆºæ¿€çš„éŠæ¨‚åœ’é«”é©—',
          transport: 'JR',
          location: 'ç’°çƒå½±åŸ',
          duration: 'å…¨å¤©',
          coordinates: [34.6654, 135.4323]
        },
        {
          time: '18:00',
          title: 'è¿”å›é£¯åº—',
          description: 'ä¼‘æ¯',
          transport: 'JR',
          location: 'å¤§é˜ªé£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '19:00',
          title: 'æ™šé¤',
          description: 'ç’°çƒå½±åŸé™„è¿‘ç¾é£Ÿ',
          location: 'ç’°çƒå½±åŸ',
          duration: '1å°æ™‚',
          coordinates: [34.6654, 135.4323]
        }
      ],
      day6: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'å¤§é˜ªé£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '09:00',
          title: 'å¤©æ©‹ç«‹',
          description: 'ä¸€æ—¥éŠï¼šæ­ä¹˜ä¸¹å¾Œç´…æ¾è™Ÿéµé“å‰å¾€å¤©æ©‹ç«‹',
          transport: 'ä¸¹å¾Œç´…æ¾è™Ÿ',
          location: 'å¤©æ©‹ç«‹',
          duration: 'å…¨å¤©',
          coordinates: [35.5667, 135.1833]
        },
        {
          time: '18:00',
          title: 'è¿”å›å¤§é˜ª',
          description: 'è¿”å›å¤§é˜ªé£¯åº—',
          transport: 'ä¸¹å¾Œç´…æ¾è™Ÿ',
          location: 'å¤§é˜ªé£¯åº—',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '20:00',
          title: 'æ™šé¤',
          description: 'å¤§é˜ªç¾é£Ÿ',
          location: 'å¤§é˜ªé£¯åº—é™„è¿‘',
          duration: '1å°æ™‚',
          coordinates: [34.7024, 135.4959]
        }
      ],
      day7: [
        {
          time: '08:00',
          title: 'æ—©é¤',
          description: 'é£¯åº—æ—©é¤',
          location: 'å¤§é˜ªé£¯åº—',
          duration: '30åˆ†é˜',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '09:00',
          title: 'è‡ªç”±æ´»å‹•',
          description: 'å¤§é˜ªæœ€å¾Œçš„è³¼ç‰©æ™‚é–“',
          location: 'å¤§é˜ªå¸‚å€',
          duration: 'ç´„3å°æ™‚',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '12:00',
          title: 'åˆé¤',
          description: 'å¤§é˜ªç¾é£Ÿ',
          location: 'å¤§é˜ªå¸‚å€',
          duration: '1å°æ™‚',
          coordinates: [34.7024, 135.4959]
        },
        {
          time: '14:00',
          title: 'å‰å¾€é—œè¥¿æ©Ÿå ´',
          description: 'æº–å‚™è¿”ç¨‹',
          transport: 'JR HARUKA',
          location: 'é—œè¥¿æ©Ÿå ´',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.4320, 135.2304]
        },
        {
          time: '16:00',
          title: 'è¿”ç¨‹',
          description: 'æ­æ©Ÿè¿”å›å°ç£',
          transport: 'é£›æ©Ÿ',
          location: 'é—œè¥¿æ©Ÿå ´ â†’ æ¡ƒåœ’æ©Ÿå ´',
          duration: 'é£›è¡Œç´„3å°æ™‚',
          coordinates: [34.4320, 135.2304]
        }
      ]
    }

    const getCurrentDayTitle = () => {
      const dayMap = {
        day1: 'Day 1 - æ¡ƒåœ’ â†’ äº¬éƒ½',
        day2: 'Day 2 - äº¬éƒ½æ™¯é»å·¡ç¦®',
        day3: 'Day 3 - äº¬éƒ½æ–‡åŒ–é«”é©—',
        day4: 'Day 4 - äº¬éƒ½ â†’ å¤§é˜ª',
        day5: 'Day 5 - ç’°çƒå½±åŸ',
        day6: 'Day 6 - å¤©æ©‹ç«‹ä¸€æ—¥éŠ',
        day7: 'Day 7 - å¤§é˜ª â†’ è¿”ç¨‹'
      }
      return dayMap[activeDay.value] || 'è¡Œç¨‹ç¸½è¦½'
    }

    const getCurrentDayItinerary = () => {
      return itineraryData[activeDay.value] || []
    }

    const initializeMap = () => {
      if (map.value) return

      // iOS Safari éœ€è¦ç‰¹æ®Šçš„è™•ç†
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent)

      map.value = L.map('map', {
        zoomControl: !isIOS, // iOS ä½¿ç”¨åŸç”Ÿæ‰‹å‹¢
        touchZoom: true,
        scrollWheelZoom: !isIOS // åœ¨iOSä¸Šç¦ç”¨æ»¾è¼ªç¸®æ”¾
      }).setView([35.0116, 135.7681], 12)

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18,
        minZoom: 8
      }).addTo(map.value)

      // iOS Safari Geolocation éœ€è¦ç‰¹æ®Šè™•ç†
      if (navigator.geolocation) {
        const geoOptions = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // 5åˆ†é˜å¿«å–
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords
            userMarker.value = L.marker([latitude, longitude], {
              icon: L.divIcon({
                className: 'user-location-marker',
                html: 'ğŸ“',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
              })
            }).addTo(map.value)
            userMarker.value.bindPopup('ğŸ“ æ‚¨ç¾åœ¨çš„ä½ç½®').openPopup()

            // å¦‚æœç”¨æˆ¶ä½ç½®åœ¨æ—¥æœ¬é™„è¿‘ï¼Œå°‡åœ°åœ–ä¸­å¿ƒç§»åˆ°ç”¨æˆ¶ä½ç½®
            if (latitude > 30 && latitude < 46 && longitude > 128 && longitude < 146) {
              map.value.setView([latitude, longitude], 13)
            }
          },
          (error) => {
            console.log('ç„¡æ³•ç²å–ä½ç½®:', error.message)
            // åœ¨iOSä¸Šé¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯
            if (error.code === error.PERMISSION_DENIED) {
              alert('è«‹å…è¨±ä½ç½®æ¬Šé™ä»¥é¡¯ç¤ºæ‚¨çš„ç¾åœ¨ä½ç½®')
            }
          },
          geoOptions
        )
      } else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½')
      }
    }

    const updateMapMarkers = () => {
      // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
      markers.value.forEach(marker => map.value.removeLayer(marker))
      markers.value = []

      const currentItinerary = getCurrentDayItinerary()
      currentItinerary.forEach((item, index) => {
        if (item.coordinates) {
          const marker = L.marker(item.coordinates)
            .addTo(map.value)
            .bindPopup(`
              <div class="text-sm">
                <h4 class="font-bold">${item.title}</h4>
                <p>${item.time} - ${item.location}</p>
                <p class="text-gray-600">${item.description}</p>
              </div>
            `)
          markers.value.push(marker)
        }
      })

      // èª¿æ•´åœ°åœ–è¦–åœ–ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
      if (markers.value.length > 0) {
        const group = new L.featureGroup(markers.value)
        map.value.fitBounds(group.getBounds().pad(0.1))
      }
    }

    const watchActiveDay = () => {
      if (showMap.value && activeDay.value !== 'overview') {
        if (!map.value) {
          initializeMap()
        }
        updateMapMarkers()
      }
    }

    onMounted(() => {
      // åˆå§‹åŒ–å€’è¨ˆæ™‚
      initializeCountdown()
      // åˆå§‹åŒ–å¤©æ°£
      initializeWeather()
    })

    const initializeCountdown = () => {
      const targetDate = new Date('2026-01-16T00:00:00').getTime()

      const updateCountdown = () => {
        const now = new Date().getTime()
        const distance = targetDate - now

        if (distance > 0) {
          const days = Math.floor(distance / (1000 * 60 * 60 * 24))
          const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
          const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
          const seconds = Math.floor((distance % (1000 * 60)) / 1000)

          document.getElementById('countdown-days').textContent = days
          document.getElementById('countdown-hours').textContent = hours
          document.getElementById('countdown-minutes').textContent = minutes
          document.getElementById('countdown-seconds').textContent = seconds
        }
      }

      updateCountdown()
      setInterval(updateCountdown, 1000)
    }

    const initializeWeather = () => {
      // æ¨¡æ“¬å¤©æ°£è³‡æ–™
      const weatherElement = document.getElementById('header-weather')
      weatherElement.innerHTML = `
        <div class="flex items-center space-x-2">
          <span class="text-lg">ğŸŒ¤ï¸</span>
          <span class="text-sm">äº¬éƒ½ 8Â°C</span>
        </div>
      `
    }

    // ç›£è¦– activeDay å’Œ showMap çš„è®ŠåŒ–
    watchActiveDay()

    return {
      activeDay,
      showMap,
      days,
      getCurrentDayTitle,
      getCurrentDayItinerary
    }
  }
}
</script>

<style>
/* Leaflet è‡ªå®šç¾©æ¨£å¼ */
.user-location-marker {
  font-size: 24px;
  text-align: center;
  line-height: 30px;
}

/* è‡ªå®šç¾©æ»¾å‹•æ¢ */
nav::-webkit-scrollbar {
  height: 4px;
}

nav::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

nav::-webkit-scrollbar-thumb {
  background: #E63946;
  border-radius: 2px;
}

nav::-webkit-scrollbar-thumb:hover {
  background: #d32f3f;
}
</style>
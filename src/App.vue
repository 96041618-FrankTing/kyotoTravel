<template>
  <div id="app" class="min-h-screen bg-light">
    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-50">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-primary">ğŸ‡¯ğŸ‡µ é—œè¥¿ä¸‰ä»£åŒå ‚ãƒ»ä¸ƒå¤©å…­å¤œè¦ªå­å­è¦ªä¹‹æ—…</h1>
            <p class="text-sm text-gray-600">2026å¹´1æœˆ16æ—¥ - 1æœˆ22æ—¥</p>
          </div>
          <div class="text-right">
            <div id="header-weather" class="text-sm text-gray-600">
              <div class="weather-loading">è¼‰å…¥å¤©æ°£ä¸­...</div>
            </div>
            <div id="countdown" class="text-xs text-gray-500 mt-1">
              <div class="countdown-label">è·é›¢å‡ºç™¼é‚„æœ‰</div>
              <div class="countdown-timer flex space-x-1">
                <div class="countdown-item">
                  <span id="countdown-days" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">å¤©</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-hours" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">æ™‚</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-minutes" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">åˆ†</span>
                </div>
                <div class="countdown-item">
                  <span id="countdown-seconds" class="countdown-number font-bold text-primary">--</span>
                  <span class="countdown-unit">ç§’</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Horizontal Date Navigation -->
    <nav class="bg-white border-b sticky top-20 z-40 overflow-x-auto">
      <div class="flex space-x-1 px-4 py-2 min-w-max">
        <button
          v-for="day in days"
          :key="day.id"
          @click="activeDay = day.id"
          :class="[
            'nav-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap',
            activeDay === day.id
              ? 'bg-primary text-white shadow-md'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          ]"
        >
          {{ day.label }}
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
      <!-- Overview Section -->
      <div v-if="activeDay === 'overview'" class="space-y-6">
        <h2 class="text-2xl font-bold text-dark mb-6">è¡Œç¨‹ç¸½è¦½</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ“… æ—…éŠæ—¥æœŸ</h3>
            <p class="text-gray-700">2026å¹´1æœˆ16æ—¥ - 1æœˆ22æ—¥</p>
            <p class="text-sm text-gray-500 mt-1">å…±7å¤©6å¤œ</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ“ ç›®çš„åœ°</h3>
            <p class="text-gray-700">äº¬éƒ½ã€å¤§é˜ªã€å¤©æ©‹ç«‹</p>
            <p class="text-sm text-gray-500 mt-1">é—œè¥¿åœ°å€æ·±åº¦éŠ</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸš„ äº¤é€šæ–¹å¼</h3>
            <p class="text-gray-700">JR HARUKAã€ICOCAã€KKdayä¸€æ—¥éŠ</p>
            <p class="text-sm text-gray-500 mt-1">å«ä¸¹å¾Œç´…æ¾è™Ÿéµé“</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold text-primary mb-2">ğŸ¨ ä½å®¿</h3>
            <p class="text-gray-700">äº¬éƒ½2æ™šã€å¤§é˜ª2æ™šã€ç’°çƒ2æ™š</p>
            <p class="text-sm text-gray-500 mt-1">æº«æ³‰é£¯åº—é«”é©—</p>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold text-dark mb-4">è¡Œç¨‹äº®é»</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸ›ï¸</span>
                <div>
                  <h4 class="font-semibold text-dark">ä¸–ç•Œéºç”¢å·¡ç¦®</h4>
                  <p class="text-sm text-gray-600">æ¸…æ°´å¯ºã€é‡‘é–£å¯ºã€ä¼è¦‹ç¨»è·å¤§ç¤¾ç­‰</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸŒ</span>
                <div>
                  <h4 class="font-semibold text-dark">å‚³çµ±æ–‡åŒ–é«”é©—</h4>
                  <p class="text-sm text-gray-600">ç¥‡åœ’è—ä¼ã€äº¬éƒ½è—ä¼é«”é©—</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸœ</span>
                <div>
                  <h4 class="font-semibold text-dark">ç¾é£Ÿæ¢ç´¢</h4>
                  <p class="text-sm text-gray-600">äº¬éƒ½æ‡·çŸ³æ–™ç†ã€å¤§é˜ªç« é­šç‡’ã€é°»é­šé£¯</p>
                </div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸš„</span>
                <div>
                  <h4 class="font-semibold text-dark">äº¤é€šä¾¿åˆ©</h4>
                  <p class="text-sm text-gray-600">JR HARUKAç›´é”ã€ICOCAä¸€å¡é€š</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸŒ¸</span>
                <div>
                  <h4 class="font-semibold text-dark">å››å­£ä¹‹ç¾</h4>
                  <p class="text-sm text-gray-600">å†¬å­£è³é›ªã€æº«æ³‰é«”é©—</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <span class="text-2xl">ğŸ¢</span>
                <div>
                  <h4 class="font-semibold text-dark">ä¸»é¡Œæ¨‚åœ’</h4>
                  <p class="text-sm text-gray-600">ç’°çƒå½±åŸã€äº¬éƒ½æ°´æ—é¤¨</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Day Sections with Map -->
      <div v-else class="space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-dark">{{ getCurrentDayTitle() }}</h2>
          <button
            @click="showMap = !showMap"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 flex items-center space-x-2"
          >
            <span>ğŸ—ºï¸</span>
            <span>{{ showMap ? 'éš±è—åœ°åœ–' : 'é¡¯ç¤ºåœ°åœ–' }}</span>
          </button>
        </div>

        <!-- Map Section -->
        <div v-if="showMap" class="bg-white rounded-lg shadow-md overflow-hidden">
          <div id="map" class="h-96 w-full"></div>
        </div>

        <!-- Itinerary Section -->
        <div class="space-y-4">
          <div
            v-for="(item, index) in getCurrentDayItinerary()"
            :key="index"
            class="bg-white rounded-lg shadow-md p-4"
          >
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                  {{ item.time }}
                </div>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-dark mb-2">{{ item.title }}</h3>
                <p class="text-gray-600 mb-2">{{ item.description }}</p>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                  <span v-if="item.transport">ğŸš„ {{ item.transport }}</span>
                  <span v-if="item.location">ğŸ“ {{ item.location }}</span>
                  <span v-if="item.duration">â±ï¸ {{ item.duration }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script>
import { ref, onMounted, onUnmounted } from 'vue'
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'

export default {
  name: 'App',
  setup() {
    const activeDay = ref('overview')
    const showMap = ref(false)
    const map = ref(null)
    const markers = ref([])
    const userMarker = ref(null)

    const days = [
      { id: 'overview', label: 'ç¸½è¦½' },
      { id: 'day1', label: 'Day 1' },
      { id: 'day2', label: 'Day 2' },
      { id: 'day3', label: 'Day 3' },
      { id: 'day4', label: 'Day 4' },
      { id: 'day5', label: 'Day 5' },
      { id: 'day6', label: 'Day 6' },
      { id: 'day7', label: 'Day 7' }
    ]

    // è¡Œç¨‹è³‡æ–™
    const itineraryData = {
      day1: [
        {
          time: '08:00-15:00',
          title: 'æ©Ÿå ´ç§»å‹•è‡³äº¬éƒ½',
          description: 'é—œè¥¿æ©Ÿå ´ â†’ äº¬éƒ½è»Šç«™ â†’ é£¯åº— Check-in',
          transport: 'JR HARUKA ç‰¹æ€¥é›»è»Š',
          location: 'é—œè¥¿æ©Ÿå ´ â†’ äº¬éƒ½è»Šç«™',
          duration: 'ç´„2.5å°æ™‚',
          coordinates: [34.4320, 135.2304]
        },
        {
          time: '15:30-17:30',
          title: 'äº¬éƒ½è»Šç«™å‘¨é‚Šæ¢éšª',
          description: 'äº¬éƒ½å¡”æˆ–Yodobashi Camera 3Fç©å…·å€',
          transport: 'èµ°è·¯',
          location: 'äº¬éƒ½è»Šç«™',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.9854, 135.7581]
        },
        {
          time: '18:00-20:00',
          title: 'æ™šé¤',
          description: 'æ±æ´‹äº­ (Porta åœ°ä¸‹è¡—)',
          location: 'äº¬éƒ½è»Šç«™ Porta åœ°ä¸‹è¡—',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.9854, 135.7581]
        }
      ],
      day2: [
        {
          time: '09:00-12:00',
          title: 'æ¸…æ°´å¯ºèˆ‡å’Œæœé«”é©—',
          description: 'æ¸…æ°´å¯º(ä»ç‹é–€)åƒè§€',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'æ¸…æ°´å¯º',
          duration: 'ç´„3å°æ™‚',
          coordinates: [34.9949, 135.7850]
        },
        {
          time: '12:00-14:00',
          title: 'äºŒä¸‰å¹´å‚æ•£ç­–',
          description: 'æ²¿è‘—çŸ³æ¿è·¯æ…¢æ…¢å¾€ä¸‹èµ°ï¼Œåˆé¤ï¼šå¥§ä¸¹æ¸…æ°´æˆ–è—¤èœç¾',
          transport: 'èµ°è·¯',
          location: 'äºŒä¸‰å¹´å‚',
          duration: 'ç´„2å°æ™‚',
          coordinates: [35.0064, 135.7850]
        },
        {
          time: '14:30-16:00',
          title: 'Mipig Cafe è¿·ä½ è±¬é«”é©—',
          description: 'è¦ªå­ç™‚ç™’é«”é©—ï¼Œèˆ‡å¯æ„›è¿·ä½ è±¬äº’å‹•',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'Mipig Cafe äº¬éƒ½åº—',
          duration: 'ç´„1.5å°æ™‚',
          coordinates: [35.0080, 135.7680]
        },
        {
          time: '16:30-18:30',
          title: 'éŒ¦å¸‚å ´ & ç¥‡åœ’',
          description: 'é€›éŒ¦å¸‚å ´ç¾é£Ÿè¡—ï¼Œæ¼«æ­¥ç¥‡åœ’èŠ±è¦‹å°è·¯',
          transport: 'èµ°è·¯',
          location: 'éŒ¦å¸‚å ´ & ç¥‡åœ’',
          duration: 'ç´„2å°æ™‚',
          coordinates: [35.0044, 135.7740]
        },
        {
          time: '19:00',
          title: 'æ™šé¤',
          description: 'æŸšå­å…ƒ (æŸšå­é‹) æˆ–æ²³åŸç”ºå‘¨é‚Šé¤å»³',
          location: 'ç¥‡åœ’',
          duration: 'ç´„1å°æ™‚',
          coordinates: [35.0044, 135.7740]
        }
      ],
      day3: [
        {
          time: '07:30-08:00',
          title: 'å‰å¾€äº¬éƒ½è»Šç«™é›†åˆ',
          description: 'é£¯åº—å‡ºç™¼å‰å¾€äº¬éƒ½è»Šç«™å…«æ¢å£ Avanti å‰',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'äº¬éƒ½è»Šç«™å…«æ¢å£',
          duration: 'ç´„30åˆ†é˜',
          coordinates: [34.9854, 135.7581]
        },
        {
          time: '08:00-19:00',
          title: 'KKday é—œè¥¿ç²¾è¯ä¸€æ—¥éŠ',
          description: 'åµå±±ã€é‡‘é–£å¯ºã€ä¼è¦‹ç¨»è·ã€å¥ˆè‰¯ä¸€æ—¥éŠ',
          transport: 'è§€å…‰éŠè¦½è»Š',
          location: 'åµå±± â†’ é‡‘é–£å¯º â†’ å¥ˆè‰¯ â†’ å¤§é˜ª',
          duration: 'ç´„11å°æ™‚',
          coordinates: [35.0142, 135.7483]
        },
        {
          time: '19:00-20:00',
          title: 'æŠµé”å¤§é˜ªé£¯åº—',
          description: 'é›£æ³¢è§£æ•£é» â†’ Hotel Sobial Namba Daikokucho',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'Hotel Sobial Namba Daikokucho',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.6544, 135.5063]
        }
      ],
      day4: [
        {
          time: '09:30-10:30',
          title: 'é›£æ³¢å…«é˜ªç¥ç¤¾',
          description: 'åƒè§€å¤§é˜ªçŸ¥åç¥ç¤¾',
          transport: 'èµ°è·¯',
          location: 'é›£æ³¢å…«é˜ªç¥ç¤¾',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.6628, 135.5011]
        },
        {
          time: '11:00-13:00',
          title: 'å¤§é˜ªåŸå…¬åœ’',
          description: 'åƒè§€å¤§é˜ªåŸï¼Œæ­å°ç«è»ŠéŠåœ’',
          transport: 'åœ°éµ',
          location: 'å¤§é˜ªåŸå…¬åœ’',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.6873, 135.5262]
        },
        {
          time: '13:30-15:30',
          title: 'é»‘é–€å¸‚å ´ & åˆé¤',
          description: 'å¤§é˜ªçŸ¥åå¸‚å ´ï¼Œå“åšæ–°é®®æµ·é®®',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'é»‘é–€å¸‚å ´',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.6686, 135.5011]
        },
        {
          time: '16:00-19:00',
          title: 'å¿ƒé½‹æ©‹ PARCO & å¤§ä¸¸',
          description: 'è³¼ç‰©è¡€æ‹¼ï¼Œåƒè§€å¯¶å¯å¤¢ä¸­å¿ƒã€ä»»å¤©å ‚å•†åº—',
          transport: 'èµ°è·¯/åœ°éµ',
          location: 'å¿ƒé½‹æ©‹ PARCO & å¤§ä¸¸',
          duration: 'ç´„3å°æ™‚',
          coordinates: [34.6739, 135.5011]
        },
        {
          time: '19:00',
          title: 'æ™šé¤ï¼šç‡’è‚‰',
          description: 'åœ‹ç”¢ç‰›ç‡’è‚‰æ”¾é¡Œ Aburiya',
          location: 'å¿ƒé½‹æ©‹',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.6739, 135.5011]
        }
      ],
      day5: [
        {
          time: '07:00-07:30',
          title: 'é€€æˆ¿èˆ‡å¯„æ”¾è¡Œæ',
          description: 'é€€æˆ¿ï¼Œå°‡è¡Œæå¯„æ”¾åœ¨ Hotel Sobial æ«ƒæª¯',
          location: 'Hotel Sobial Namba Daikokucho',
          duration: 'ç´„30åˆ†é˜',
          coordinates: [34.6544, 135.5063]
        },
        {
          time: '07:30-07:45',
          title: 'å‰å¾€é›†åˆåœ°é»',
          description: 'å‰å¾€å¤§é˜ªèŸ¹é“æ¨‚é“é “å €æ±åº—é›†åˆ',
          transport: 'è¨ˆç¨‹è»Š',
          location: 'å¤§é˜ªèŸ¹é“æ¨‚é“é “å €æ±åº—',
          duration: 'ç´„15åˆ†é˜',
          coordinates: [34.6686, 135.5011]
        },
        {
          time: '08:00-18:30',
          title: 'KKday ä¸¹å¾Œç´…æ¾è™Ÿä¸€æ—¥éŠ',
          description: 'å¤©æ©‹ç«‹ã€é¤µæµ·é·—ã€ç´…æ¾è™Ÿåˆ—è»Šé«”é©—',
          transport: 'ä¸¹å¾Œç´…æ¾è™Ÿåˆ—è»Š',
          location: 'å¤©æ©‹ç«‹',
          duration: 'ç´„10.5å°æ™‚',
          coordinates: [35.5667, 135.1833]
        },
        {
          time: '19:00-20:30',
          title: 'è¿”å›é£¯åº—æ‹¿è¡Œæ',
          description: 'è¿”å›å¤§é˜ªé£¯åº—æ‹¿è¡Œæï¼Œç§»å‹•è‡³ç’°çƒå½±åŸé£¯åº—',
          transport: 'åœ°éµ + è¨ˆç¨‹è»Š',
          location: 'The Singulari Hotel & Skyspa',
          duration: 'ç´„1.5å°æ™‚',
          coordinates: [34.6654, 135.4323]
        }
      ],
      day6: [
        {
          time: '08:30-20:00',
          title: 'å¤§é˜ªç’°çƒå½±åŸå…¨æ—¥éŠ',
          description: 'ä»»å¤©å ‚ä¸–ç•Œã€å“ˆåˆ©æ³¢ç‰¹ã€å°å°å…µç­‰ç²¾å½©è¨­æ–½',
          transport: 'èµ°è·¯',
          location: 'ç’°çƒå½±åŸ',
          duration: 'ç´„11.5å°æ™‚',
          coordinates: [34.6654, 135.4323]
        },
        {
          time: '20:00',
          title: 'CityWalk æ™šé¤',
          description: 'ç’°çƒå½±åŸ CityWalk å€äº«ç”¨æ™šé¤',
          location: 'ç’°çƒå½±åŸ CityWalk',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.6654, 135.4323]
        }
      ],
      day7: [
        {
          time: '10:00',
          title: 'é€€æˆ¿èˆ‡ç§»å‹•',
          description: 'æ¨è¡Œææ­¥è¡Œè‡³å·´å£«ç¸½ç«™',
          transport: 'èµ°è·¯',
          location: 'ç’°çƒå½±åŸå·´å£«ç¸½ç«™',
          duration: 'ç´„30åˆ†é˜',
          coordinates: [34.6654, 135.4323]
        },
        {
          time: '10:27-11:30',
          title: 'æ­ä¹˜åˆ©æœ¨æ´¥å·´å£«',
          description: 'å‰å¾€é—œè¥¿æ©Ÿå ´',
          transport: 'åˆ©æœ¨æ´¥å·´å£«',
          location: 'é—œè¥¿æ©Ÿå ´',
          duration: 'ç´„1å°æ™‚',
          coordinates: [34.4320, 135.2304]
        },
        {
          time: '12:00-14:00',
          title: 'é—œè¥¿æ©Ÿå ´',
          description: 'è¾¦ç†ç™»æ©Ÿæ‰‹çºŒï¼Œæº–å‚™è¿”ç¨‹',
          location: 'é—œè¥¿æ©Ÿå ´',
          duration: 'ç´„2å°æ™‚',
          coordinates: [34.4320, 135.2304]
        },
        {
          time: '14:30',
          title: 'è¿”ç¨‹',
          description: 'æ­æ©Ÿè¿”å›å°ç£',
          transport: 'ä¸­è¯èˆªç©º CI153',
          location: 'é—œè¥¿æ©Ÿå ´ â†’ æ¡ƒåœ’æ©Ÿå ´',
          duration: 'é£›è¡Œç´„3å°æ™‚',
          coordinates: [34.4320, 135.2304]
        }
      ]
    }

    const getCurrentDayTitle = () => {
      const dayMap = {
        day1: 'Day 1 - æŠµé”äº¬éƒ½ãƒ»éµé“èˆ‡æº«æ³‰æ”¾é¬†',
        day2: 'Day 2 - äº¬éƒ½ç¶“å…¸ï¼šæ¸…æ°´å¯ºãƒ»å°è±¬ç™‚ç™’ãƒ»ç¥‡åœ’',
        day3: 'Day 3 - é—œè¥¿ç²¾è¯ä¸€æ—¥éŠ (ç§»å‹•æ—¥)',
        day4: 'Day 4 - å¤§é˜ªå¸‚å€ï¼šå¯¶å¯å¤¢èˆ‡æ­·å²äº¤éŒ¯',
        day5: 'Day 5 - æµ·ä¹‹äº¬éƒ½ï¼šä¸¹å¾Œç´…æ¾è™Ÿãƒ»å¤©æ©‹ç«‹çµ•æ™¯',
        day6: 'Day 6 - å¤§é˜ªç’°çƒå½±åŸ (USJ)',
        day7: 'Day 7 - è¼•é¬†è¿”å°'
      }
      return dayMap[activeDay.value] || 'è¡Œç¨‹ç¸½è¦½'
    }

    const getCurrentDayItinerary = () => {
      return itineraryData[activeDay.value] || []
    }

    const initializeMap = () => {
      if (map.value) return

      // iOS Safari éœ€è¦ç‰¹æ®Šçš„è™•ç†
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent)

      map.value = L.map('map', {
        zoomControl: !isIOS, // iOS ä½¿ç”¨åŸç”Ÿæ‰‹å‹¢
        touchZoom: true,
        scrollWheelZoom: !isIOS // åœ¨iOSä¸Šç¦ç”¨æ»¾è¼ªç¸®æ”¾
      }).setView([35.0116, 135.7681], 12)

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18,
        minZoom: 8
      }).addTo(map.value)

      // iOS Safari Geolocation éœ€è¦ç‰¹æ®Šè™•ç†
      if (navigator.geolocation) {
        const geoOptions = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // 5åˆ†é˜å¿«å–
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords
            userMarker.value = L.marker([latitude, longitude], {
              icon: L.divIcon({
                className: 'user-location-marker',
                html: 'ğŸ“',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
              })
            }).addTo(map.value)
            userMarker.value.bindPopup('ğŸ“ æ‚¨ç¾åœ¨çš„ä½ç½®').openPopup()

            // å¦‚æœç”¨æˆ¶ä½ç½®åœ¨æ—¥æœ¬é™„è¿‘ï¼Œå°‡åœ°åœ–ä¸­å¿ƒç§»åˆ°ç”¨æˆ¶ä½ç½®
            if (latitude > 30 && latitude < 46 && longitude > 128 && longitude < 146) {
              map.value.setView([latitude, longitude], 13)
            }
          },
          (error) => {
            console.log('ç„¡æ³•ç²å–ä½ç½®:', error.message)
            // åœ¨iOSä¸Šé¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯
            if (error.code === error.PERMISSION_DENIED) {
              alert('è«‹å…è¨±ä½ç½®æ¬Šé™ä»¥é¡¯ç¤ºæ‚¨çš„ç¾åœ¨ä½ç½®')
            }
          },
          geoOptions
        )
      } else {
        console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½')
      }
    }

    const updateMapMarkers = () => {
      // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
      markers.value.forEach(marker => map.value.removeLayer(marker))
      markers.value = []

      const currentItinerary = getCurrentDayItinerary()
      currentItinerary.forEach((item, index) => {
        if (item.coordinates) {
          const marker = L.marker(item.coordinates)
            .addTo(map.value)
            .bindPopup(`
              <div class="text-sm">
                <h4 class="font-bold">${item.title}</h4>
                <p>${item.time} - ${item.location}</p>
                <p class="text-gray-600">${item.description}</p>
              </div>
            `)
          markers.value.push(marker)
        }
      })

      // èª¿æ•´åœ°åœ–è¦–åœ–ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
      if (markers.value.length > 0) {
        const group = new L.featureGroup(markers.value)
        map.value.fitBounds(group.getBounds().pad(0.1))
      }
    }

    const watchActiveDay = () => {
      if (showMap.value && activeDay.value !== 'overview') {
        if (!map.value) {
          initializeMap()
        }
        updateMapMarkers()
      }
    }

    onMounted(() => {
      // åˆå§‹åŒ–å€’è¨ˆæ™‚
      initializeCountdown()
      // åˆå§‹åŒ–å¤©æ°£
      initializeWeather()
    })

    const initializeCountdown = () => {
      const targetDate = new Date('2026-01-16T00:00:00').getTime()

      const updateCountdown = () => {
        const now = new Date().getTime()
        const distance = targetDate - now

        if (distance > 0) {
          const days = Math.floor(distance / (1000 * 60 * 60 * 24))
          const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
          const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
          const seconds = Math.floor((distance % (1000 * 60)) / 1000)

          document.getElementById('countdown-days').textContent = days
          document.getElementById('countdown-hours').textContent = hours
          document.getElementById('countdown-minutes').textContent = minutes
          document.getElementById('countdown-seconds').textContent = seconds
        }
      }

      updateCountdown()
      setInterval(updateCountdown, 1000)
    }

    const initializeWeather = () => {
      // æ¨¡æ“¬å¤©æ°£è³‡æ–™
      const weatherElement = document.getElementById('header-weather')
      weatherElement.innerHTML = `
        <div class="flex items-center space-x-2">
          <span class="text-lg">ğŸŒ¤ï¸</span>
          <span class="text-sm">äº¬éƒ½ 8Â°C</span>
        </div>
      `
    }

    // ç›£è¦– activeDay å’Œ showMap çš„è®ŠåŒ–
    watchActiveDay()

    return {
      activeDay,
      showMap,
      days,
      getCurrentDayTitle,
      getCurrentDayItinerary
    }
  }
}
</script>

<style>
/* Leaflet è‡ªå®šç¾©æ¨£å¼ */
.user-location-marker {
  font-size: 24px;
  text-align: center;
  line-height: 30px;
}

/* è‡ªå®šç¾©æ»¾å‹•æ¢ */
nav::-webkit-scrollbar {
  height: 4px;
}

nav::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

nav::-webkit-scrollbar-thumb {
  background: #E63946;
  border-radius: 2px;
}

nav::-webkit-scrollbar-thumb:hover {
  background: #d32f3f;
}
</style>